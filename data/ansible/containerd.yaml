#
# (C) Copyright IBM Corp. 2023.
# SPDX-License-Identifier: Apache-2.0
#

---
- hosts: all
  become: true
  vars:
    binaries_architecture: {
      "s390x": "s390x",
      "x86_64": "amd64"
    }
  tasks:
    - include_tasks: tasks/bootstrap.yaml
    - include_tasks: tasks/k8s.yaml
    - include_tasks: tasks/binaries.yaml

    - name: "Create a directory for containerd config"
      file: path=/etc/containerd state=directory

    - name: Load kernel modules
      modprobe:
        name: "{{ item }}"
      with_items:
        - br_netfilter
        - overlay

    - name: Set sysctl parameters for Kubernetes
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        reload: yes
      with_items:
        - { name: net.ipv4.ip_forward, value: 1 }
        - { name: net.bridge.bridge-nf-call-ip6tables, value: 1 }
        - { name: net.bridge.bridge-nf-call-iptables, value: 1 }

    - name: Configure containerd to start using systemd as cgroup
      ansible.builtin.shell:
        containerd config default | sudo tee /etc/containerd/config.toml >/dev/null 2>&1
        
    - name: "Modify SystemdCgroup"
      ansible.builtin.replace:
       path: /etc/containerd/config.toml
       regexp: 'SystemdCgroup = false'
       replace: 'SystemdCgroup = true'    

    - name: "Start Containerd"
      systemd: name=containerd daemon_reload=yes state=restarted enabled=yes
